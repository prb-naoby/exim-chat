# =============================================================================
# EXIM Chat - Production Docker Compose (Using GHCR Images)
# =============================================================================
# Usage: docker-compose -f docker-compose.prod.yml up -d
# =============================================================================

services:
  backend:
    image: ghcr.io/${GITHUB_REPOSITORY:-prb-naoby/exim-chat}:latest
    container_name: exim-backend
    restart: unless-stopped
    ports:
      - "3333:3333"
    volumes:
      - exim_data:/app/data
      - exim_logs:/app/logs
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - APP_PASSWORD=${APP_PASSWORD}
      - INSW_QDRANT_URL=${INSW_QDRANT_URL}
      - INSW_QDRANT_API_KEY=${INSW_QDRANT_API_KEY}
      - INSW_QDRANT_COLLECTION_NAME=${INSW_QDRANT_COLLECTION_NAME}
      - SOP_QDRANT_URL=${SOP_QDRANT_URL}
      - SOP_QDRANT_API_KEY=${SOP_QDRANT_API_KEY}
      - SOP_QDRANT_COLLECTION_NAME=${SOP_QDRANT_COLLECTION_NAME}
      - CASES_QDRANT_COLLECTION_NAME=${CASES_QDRANT_COLLECTION_NAME}
      - CONFIDENCE_THRESHOLD=${CONFIDENCE_THRESHOLD}
      - LLM_MODEL=${LLM_MODEL}
      - SOP_FOLDER_PATH=${SOP_FOLDER_PATH}
      - GENERAL_FOLDER_PATH=${GENERAL_FOLDER_PATH}
      - CASES_FOLDER_PATH=${CASES_FOLDER_PATH}
      - ONEDRIVE_DRIVE_ID=${ONEDRIVE_DRIVE_ID}
      - MS_TENANT_ID=${MS_TENANT_ID}
      - MS_CLIENT_ID=${MS_CLIENT_ID}
      - MS_CLIENT_SECRET=${MS_CLIENT_SECRET}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - CASES_QDRANT_URL=${CASES_QDRANT_URL}
      - CASES_QDRANT_API_KEY=${CASES_QDRANT_API_KEY}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL}
      - VECTOR_SIZE=${VECTOR_SIZE}
      - INSW_FOLDER_PATH=${INSW_FOLDER_PATH}
      - GENERAL_QDRANT_COLLECTION_NAME=${GENERAL_QDRANT_COLLECTION_NAME}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - TZ=Asia/Jakarta
    networks:
      - exim_network
      - redis
      - nginx-network
    healthcheck:
      test: [ "CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:3333/')" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  frontend:
    build: ./frontend
    container_name: exim-frontend
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:3333}
      - TZ=Asia/Jakarta
    networks:
      - exim_network
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  exim_data:
  exim_logs:


networks:
  exim_network:
    name: exim_network
  redis:
    external: true
  nginx-network:
    external: true
